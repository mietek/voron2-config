[include mainsail.cfg]
[include stealthburner_leds.cfg] 
[exclude_object]
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_24001E000F51313236343430-if00

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000             #Max 4000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

[input_shaper]
shaper_freq_x: 50
shaper_freq_y: 42
shaper_type: mzv

#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PE4
dir_pin: !PE5
enable_pin: !PE3
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  
endstop_pin: PF4
position_min: 0
position_endstop: 350
position_max: 350
homing_speed: 25   #Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PG13
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
step_pin: PE1
dir_pin: PE0
enable_pin: !PE2
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:400  
endstop_pin: PC15
position_min: 0
position_endstop: 350
position_max: 350
homing_speed: 25  #Max 100
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PG12
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
 
#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z1]
step_pin: PB8
dir_pin: !PB9
enable_pin: !PB7
rotation_distance: 40
gear_ratio: 80:20
microsteps: 32



[tmc2209 stepper_z1]
uart_pin: PG11
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
rotation_distance: 40
gear_ratio: 80:20
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PG10
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z3]
step_pin: PG15
dir_pin: !PB3
enable_pin: !PD5
rotation_distance: 40
gear_ratio: 80:20
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PG9
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z]
step_pin: PD3
dir_pin: PD2
enable_pin: !PD4
rotation_distance: 40
gear_ratio: 80:20
microsteps: 32
endstop_pin: probe:z_virtual_endstop
position_max: 305
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin:  PD7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
rotation_distance: 5.7
#gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200   
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PF6
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PB0
min_temp: 10
max_temp: 290
max_power: 1.0
min_extrude_temp: 100
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
pressure_advance: 0.05
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: PG14
interpolate: false
run_current: 0.55
sense_resistor: 0.110
stealthchop_threshold: 0


#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PF7
sensor_type: Generic 3950
sensor_pin: PB1
max_power: 0.8
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

[probe]
pin: !PB15
x_offset: 0
y_offset: 25.0
#z_offset: 0
speed: 10.0
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.01
samples_tolerance_retries: 3

#####################################################################
#   Fan Control
#####################################################################

##  Print Cooling Fan - FAN0
[fan]
pin: PA4
kick_start_time: 0.5
off_below: 0.10

##  Hotend Fan - FAN1
[heater_fan hotend_fan]
pin: PA5
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

##  Controller fan - FAN2
[heater_fan controller_fan]
pin: PF9
#kick_start_time: 0.5
heater: heater_bed
heater_temp: 50

#####################################################################
#   LED Control
#####################################################################

[output_pin caselight]
pin: PA6
pwm:true
shutdown_value: 0
value:0.3
cycle_time: 0.01

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 991800

[safe_z_home]
home_xy_position:175,175
speed:200
z_hop:10

[quad_gantry_level]
gantry_corners:
   -60,-10
   410,420
##  Probe points
points:
   50,25
   50,275
   300,275
   300,25
speed: 300
horizontal_move_z: 15
retries: 3
retry_tolerance: 0.01
max_adjust: 10


[bed_mesh]
speed: 300
horizontal_move_z: 10
mesh_min: 40, 40
mesh_max: 310,310
fade_start: 0.6
fade_end: 10.0
probe_count: 9,9
algorithm: bicubic
relative_reference_index: 12


#####################################################################
#   Macros
#####################################################################
[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro G32]
gcode:
    STATUS_LEVELING
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    PARK
    RESTORE_GCODE_STATE NAME=STATE_G32
    STATUS_READY
   
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G32                            ; home all axes
    G90                            ; absolute positioning
    G1 Z20 F3000                   ; move nozzle away from bed
    BED_MESH_PROFILE LOAD=default
   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0




[force_move]
enable_force_move: True

[gcode_macro FAKE_POSITION]
gcode:
        SET_KINEMATIC_POSITION X=0 Y=0 Z=20

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.002500, 0.023750, 0.040000, 0.033750, 0.008750, -0.011250, -0.003750, 0.011250, 0.010000
#*# 	-0.018750, 0.005000, 0.025000, 0.015000, -0.003750, 0.000000, 0.011250, 0.003750, -0.015000
#*# 	-0.021250, -0.001250, 0.005000, 0.003750, 0.001250, -0.003750, -0.005000, 0.006250, -0.018750
#*# 	-0.035000, -0.011250, 0.007500, 0.013750, -0.003750, 0.003750, 0.008750, -0.001250, -0.026250
#*# 	-0.035000, -0.011250, 0.012500, -0.001250, 0.002500, -0.001250, -0.000000, -0.006250, -0.030000
#*# 	-0.026250, 0.002500, 0.035000, 0.011250, 0.007500, 0.003750, 0.011250, -0.001250, -0.017500
#*# 	-0.000000, 0.031250, 0.041250, 0.023750, 0.025000, 0.023750, 0.026250, 0.015000, -0.017500
#*# 	-0.012500, 0.001250, 0.032500, 0.023750, 0.027500, 0.022500, 0.035000, 0.021250, -0.006250
#*# 	-0.008750, 0.013750, 0.040000, 0.030000, 0.026250, 0.031250, 0.023750, 0.005000, -0.016250
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 310.0
#*# min_y = 40.0
#*# max_y = 310.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 33.631
#*# pid_ki = 4.230
#*# pid_kd = 66.841
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.794
#*# pid_ki = 1.757
#*# pid_kd = 225.335
#*#
#*# [probe]
#*# z_offset = -0.150
